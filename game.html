<!DOCTYPE html>
<html>
<head>
	<title>Memory Swipe</title>

	<!-- Main jQuery scripts & CSS (unchanging) {{{ -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
	<script src='http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js'></script>
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
	<link rel="stylesheet" href="themes/jquery.mobile.icons.min.css" />
	
	
	<!-- 3rd party and our common scripts / css -->
	<script src='js/patternlock/patternLock.js'></script>
	<link href="js/patternlock/patternLock.css"  rel="stylesheet" type="text/css" />

	<!--Cookie-->
	<script src='js/cookie_load_write.js'></script>
	<script src='js/functions.js'></script>

	<!--<link rel="stylesheet" type="text/css" href="assets/css/main.css"/>-->
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
	<link rel="stylesheet" href="themes/darkTheme.min.css" />

	<!-- Meta stuff -->
	<link rel="apple-touch-icon" href="resources/game_icon.png">
	<link rel="apple-touch-startup-image" href="resources/apple-splash.png">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<meta name="viewport" content="width=device-width">
	<meta name="viewport" content="initial-scale=1.0"><!-- }}} -->

	<script>
	var buttonRadius = 0;
	var buttonMargin = 0;
	var matrixSize = 320; //physical matrix size
	var gridSize = 10; //size of grid 5x5, 4x4
	var rowSize = gridSize; //row size
	var numberRange = 10; //number of answers
	var maxNumber = Math.pow(rowSize, 2);//max number
	var test_pattern = 161116; // 1 6 11 16
	var progress = [0, 0, 0, 0, 0,
					0, 0, 0, 0, 0]; //user progress 0: off, 1: on, 2:current
	var progressIndex = 0;// user progress index

	if(!empty(getCookie('progressIndex'))){
		progressIndex = getCookie('progressIndex');
		console.log("progressIndex" + progressIndex);
	}

	if(!empty(getCookie('progress'))){
		progress = getCookie('progress').split('|');
		console.log("progress" + progress);
	}

	/* capital G because we use it as an object */
	function GridButton(value, values, rows, columns) // {{{
	{
		if( empty(value) || value < 1 || value > (rows*columns)) 
		{
			alert('Invalid gridButton value: '+value);
			return false;
		}

		this.value = value;
		this.values = values;
		this.index = value-1;
		this.rows = rows;
		this.columns = columns;
		this.numGridButtons = rows*columns;		

		this.nearest = [];

		this.firstRow = function()
		{
			return this.value <= columns;
		}
		this.lastRow = function()
		{
			return this.value > (this.numGridButtons - columns);		
		}
		this.firstColumn = function()
		{
			return (this.index == 0 || this.index % columns == 0)
		}
		this.lastColumn = function()
		{
			return this.value % columns == 0;
		}
		this.up = function()
		{
			return this.value - this.columns;
		}
		this.down = function()
		{
			return this.value + this.columns;
		}

		this.getNearest = function()
		{
			/*
			console.log("Previous num: "+this.value);
			console.log("firstRow? "+this.firstRow());
			console.log("lastRow? "+this.lastRow());
			console.log("firstCol? "+this.firstColumn());
			console.log("lastCol? "+this.lastColumn());
			*/
			if(!this.firstRow() && !this.firstColumn()) 	this.add(this.up() - 1);
			if(!this.firstRow())							this.add(this.up());
			if(!this.firstRow() && !this.lastColumn())		this.add(this.up() + 1);
			if(!this.lastColumn())							this.add(this.value + 1);
			if(!this.lastRow() && !this.lastColumn())		this.add(this.down() + 1);
			if(!this.lastRow())								this.add(this.down());
			if(!this.lastRow() && !this.firstColumn())		this.add(this.down() - 1);
			if(!this.firstColumn())							this.add(this.value - 1);
	
			return this.nearest;
		}

		this.add = function(val)
		{
			if(this.values.indexOf(val) == -1 && this.nearest.indexOf(val) == -1) 
			{
				this.nearest.push(val);
			}

		}
	} // }}}

	function getNextNumber(grid) // {{{
	{
		var nextNum = 0;

		if(grid.length == 0)
		{
			nextNum = Math.ceil(Math.random() * (gridSize*gridSize));
		}
		else
		{
			var lastButton = new GridButton(grid[grid.length - 1], grid, gridSize, gridSize);
			var values = lastButton.getNearest();
			//console.log("Button "+grid[grid.length-1]+" values: "+JSON.stringify(values));

			nextNum = values[Math.ceil(Math.random() * values.length) - 1];
		}
		return nextNum;
	} // }}}

	(function generateAnswer(){ // {{{ Generate the answer
		var answer = [];
	
		while(answer.length < numberRange){
			answer[answer.length] = getNextNumber(answer);
		}

		//print out console
		for(var i = 0; i < answer.length; i++){
			console.log(answer[i] + " ");
		}
		
		setCookie('answer', answer.join('|'), 365);

		console.log(decodeURI(getCookie('answer')).split('|').join(''));
	}()); // }}}

	// Math to determine elements sizes
	buttonRadius = matrixSize / rowSize;
	buttonMargin = buttonRadius / 10;
	buttonRadius = buttonRadius/2 - (buttonMargin * 2);

	$(document).ready(function(){
		
		// enable vibration support
		navigator.vibrate = navigator.vibrate || navigator.webkitVibrate || navigator.mozVibrate || navigator.msVibrate;

		if (navigator.vibrate) {
				// vibration API supported
		}

		(function showUserProgress(){
				var progressBar = document.getElementById("progressBar");
				//generating progress buttons
				for(var i = 0; i < 10; i++){
					var button = document.createElement("div");
					button.className = "progressButtonOff";
					button.id = "progress" + i;

					progressBar.appendChild(button);
				}

				//check user progress and visualizing based on userProgress array
				for(var i = 0; i <= progressIndex; i++){
					if(progress[i] == 0){
				 	document.getElementById("progress" + i).className = "progressButtonOff";
					} else if(progress[i] == 1) {
						document.getElementById("progress" + i).className = "progressButtonOn";
					} else {
						document.getElementById("progress" + i).className = "progressButtonCurrent";
					}
				}//end of for
		}());	//end of funciton

		var lock = new PatternLock('#pattern', // Generate a grid
		{
			matrix : [gridSize, gridSize],
			margin : buttonMargin,
    		radius: buttonRadius,
	        patternVisible: true,
	        lineOnMove: true,
	        delimiter: "", // a delimeter between the pattern
	        enableSetPattern: false,

			onDraw:function(pattern) {
					var answer = decodeURI(getCookie('answer')).split('|').join('');

					console.log("comparing input ("+pattern+") to answer ("+answer+")");

                    if(pattern == answer) {
                    	progress[progressIndex++] = 1;

                    	setCookie('porgressIndex', progressIndex, 365)
						setCookie('progress', progress.join('|'), 365);

						alert('pass');
						location.reload();
					} else {
						lock.error();
					}

                    window.setTimeout(function() { lock.reset(); }, 1000);
                }
		});
	});

    function onResult()  {
   		window.location = 'result.php'
    }
	</script>

</head>


<body>
	<div class="maincontainer">
		<div>
			<input type="button" class='menu' value = 'Menu' onclick='location.href = "index.html"'/>
		</div>

		<div id="progressBar">
		</div>

		<div id="stopWatch">
			99:99
		</div>

		<!--Pattern Grid-->
	    <div id="pattern">
	    </div>

	    <div class="button">
				<input type='button' class='skipBtn' value='Skip' onclick='onResult()'>
	    </div>
	</div>
</body>

<style type="text/css">
	body{
		background-color:#232323;
	}

	.maincontainer {
	  margin: 0 auto;
	  right: auto;
	  bottom: auto;
	  width: 320px;
	  height: 100%;
	  background-color: #232323;
	  color: #FFF;
	  text-align: center;
	  /* border-radius: 10px; */
	  overflow: none;
	}

	#progressBar {
		height: 30px;
		background-color: #404040;
		margin-bottom: 1%;
	}	

	.progressButtonCurrent {
		float:left;
		width: 25px;
		height: 25px;
		margin:2.5px 2.5px 2.5px 2.5px;
		border-radius:15px;
		background-color:#00FF90;
	}

	.progressButtonOff {
		float:left;
		width: 25px;
		height: 25px;
		margin:2.5px 2.5px 2.5px 2.5px;
		border-radius:15px;
		background-color:#fff;
	}

	.progressButtonOn {
		float:left;
		width: 25px;
		height: 25px;
		margin:2.5px 2.5px 2.5px 2.5px;
		border-radius:15px;
		background-color:#fff;

	}

	#stopWatch{
		text-align: right;
		font-size: 170%;
		padding-right: 1%;
		margin:0;
	}

	#pattern{
		background-color: #404040;
		margin-bottom:5%;
	}
</style>


</html>
